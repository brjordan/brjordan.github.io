<!doctype html>
<html lang="en">
<head><title>Sound</title><meta charset="utf-8"></head>
<body>
<p id=p_help>Use keys 1-7 to select mode. <br/>All other character keys play notes.</p>
<p id=p_mode>?p_mode?</p>
<p id=p_a4Key>?p_a4Key?</p>
<script id="script_main" type="text/javascript">
//don't preventDefault() on these keys
const noPrevDef = [ "F5", "F12" ];

const keyTable = {
	'`' : 0, '~' : 0,
	'1' : 1, '!' : 1,
	'2' : 2, '@' : 2,
	'3' : 3, '#' : 3,
	'4' : 4, '$' : 4,
	'5' : 5, '%' : 5,
	'6' : 6, '^' : 6,
	'7' : 7, '&' : 7,
	'8' : 8, '*' : 8,
	'9' : 9, '(' : 9,
	'0' : 10, ')' : 10,
	'-' : 11, '_' : 11,
	'=' : 12, '+' : 12,
	'q' : 13, 'Q' : 13,
	'w' : 14, 'W' : 14,
	'e' : 15, 'E' : 15,
	'r' : 16, 'R' : 16,
	't' : 17, 'T' : 17,
	'y' : 18, 'Y' : 18,
	'u' : 19, 'U' : 19,
	'i' : 20, 'I' : 20,
	'o' : 21, 'O' : 21,
	'p' : 22, 'P' : 22,
	'[' : 23, '{' : 23,
	']' : 24, '}' : 24,
	'\\' : 25, '|' : 25,
	'a' : 26, 'A' : 26,
	's' : 27, 'S' : 27,
	'd' : 28, 'D' : 28,
	'f' : 29, 'F' : 29,
	'g' : 30, 'G' : 30,
	'h' : 31, 'H' : 31,
	'j' : 32, 'J' : 32,
	'k' : 33, 'K' : 33,
	'l' : 34, 'L' : 34,
	';' : 35, ':' : 35,
	"'" : 36, '"' : 36,
	'z' : 37, 'Z' : 37,
	'x' : 38, 'X' : 38,
	'c' : 39, 'C' : 39,
	'v' : 40, 'V' : 40,
	'b' : 41, 'B' : 41,
	'n' : 42, 'N' : 42,
	'm' : 43, 'M' : 43,
	',' : 44, '<' : 44,
	'.' : 45, '>' : 45,
	'/' : 46, '?' : 46,
	' ' : 47
};

var keyArray = [];
keyArray.length = 48;
keyArray.fill(false);

const modeSteps = [ 
	[0,2,4,5,7,9,11], 
	[0,2,3,5,7,9,10], 
	[0,1,3,5,7,8,10], 
	[0,2,4,6,7,9,11], 
	[0,2,4,5,7,9,10], 
	[0,2,3,5,7,8,10], 
	[0,1,3,5,6,8,10] 
];

const modeNames = [
	"Ionian", 
	"Dorian", 
	"Phrygian", 
	"Lydian", 
	"Mixolydian", 
	"Aeolian", 
	"Locrian"
];

var modeCurr = 0;

const root12th2 = Math.pow(2, 1/12);
const a4hz = 440.00;
const a4Key = 's';
var aCtx = new (window.AudioContext || window.webkitAudioContext)();
var oscs = [];
var conv = aCtx.createConvolver();
var gain = aCtx.createGain();

conv.buffer = impulseResponse(8,128,false);
gain.gain.value = 0.1;

conv.connect(gain);
gain.connect(aCtx.destination);

updateMode();
document.getElementById("p_a4Key").innerHTML = "A440 key: " + a4Key;

document.addEventListener('keydown', (event) => {
	if (!noPrevDef.includes(event.key)) { event.preventDefault(); }
	if (event.repeat) { return; }
	if (!(keyArray[keyTable[event.key]] = true)) { return; }
	var keyCode = keyTable[event.key];
	if (keyCode <= 7 && keyCode >= 1) { 
		modeCurr = keyCode - 1; 
		updateMode();
	} else {
		var note = keyCode - keyTable[a4Key];
		note = Math.floor(note / 7)*12 + modeSteps[modeCurr][(((note % 7) + 7) % 7)];
		console.log(note);
		oscs[keyCode] = aCtx.createOscillator();
		oscs[keyCode].onended = function() { oscs[keyCode] = null; };
		oscs[keyCode].type = 'sawtooth';
		oscs[keyCode].frequency.value = noteHz(note);
		oscs[keyCode].connect(conv);
		oscs[keyCode].start();
	}	
});

document.addEventListener('keyup', (event) => {
	if (keyArray[keyTable[event.key]]) { 
		keyArray[keyTable[event.key]] = false;
	} else { 
		return; 
	}
	var keyCode = keyTable[event.key];
	if (!oscs[keyCode]) { return; }
	oscs[keyCode].stop();
});

function noteHz(n) {
	return a4hz * Math.pow(root12th2, n);
}

function updateMode() {
	document.getElementById("p_mode").innerHTML = "Mode: " + modeNames[modeCurr];
}

function impulseResponse( duration, decay, reverse ) {
    var sampleRate = aCtx.sampleRate;
    var length = sampleRate * duration;
    var impulse = aCtx.createBuffer(2, length, sampleRate);
    var impulseL = impulse.getChannelData(0);
    var impulseR = impulse.getChannelData(1);

    if (!decay)
        decay = 2.0;
    for (var i = 0; i < length; i++){
      var n = reverse ? length - i : i;
      impulseL[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
      impulseR[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
    }
    return impulse;
}
</script>
</body>
</html>