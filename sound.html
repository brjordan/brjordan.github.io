<!doctype html>
<html lang="en">
<head><title>Sound</title><meta charset="utf-8"></head>
<body>
<p>black keys: S,D,G,H,J<br/>white keys: Z,X,C,V,B,N,M</p>
<script id="script_main" type="text/javascript">
var a_ctx = new (window.AudioContext || window.webkitAudioContext)();
var oscs = [];
var conv = a_ctx.createConvolver();
var gain = a_ctx.createGain();

conv.buffer = impulseResponse(4,4,false);
gain.gain.value = 0.2;

conv.connect(gain);
gain.connect(a_ctx.destination);

document.addEventListener('keydown', (event) => {
	const key_code = event.keyCode;
	if (oscs[key_code]) { return; }
	var freq;
	if(key_code == 90) { freq =  261.63; }
	else if(key_code == 83) { freq =  277.18; }
	else if(key_code == 88) { freq =  293.66; }
	else if(key_code == 68) { freq =  311.13; }
	else if(key_code == 67) { freq =  329.63; }
	else if(key_code == 86) { freq =  349.23; }
	else if(key_code == 71) { freq =  369.99; }
	else if(key_code == 66) { freq =  392.00; }
	else if(key_code == 72) { freq =  415.30; }
	else if(key_code == 78) { freq =  440.00; }
	else if(key_code == 74) { freq =  466.16; }
	else if(key_code == 77) { freq =  493.88; }
	else { return; }
	oscs[key_code] = a_ctx.createOscillator();
	oscs[key_code].onended = function() { oscs[key_code] = null; };
	oscs[key_code].type = 'sawtooth';
	oscs[key_code].frequency.value = freq;
	oscs[key_code].connect(conv);
	oscs[key_code].start();
});

document.addEventListener('keyup', (event) => {
	const key_code = event.keyCode;
	if (!oscs[key_code]) { return; }
	oscs[key_code].stop();
});

function impulseResponse( duration, decay, reverse ) {
    var sampleRate = a_ctx.sampleRate;
    var length = sampleRate * duration;
    var impulse = a_ctx.createBuffer(2, length, sampleRate);
    var impulseL = impulse.getChannelData(0);
    var impulseR = impulse.getChannelData(1);

    if (!decay)
        decay = 2.0;
    for (var i = 0; i < length; i++){
      var n = reverse ? length - i : i;
      impulseL[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
      impulseR[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
    }
    return impulse;
}
</script>
</body>
</html>