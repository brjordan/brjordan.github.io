<!doctype html>
<html lang="en">
<head><title>Sound</title><meta charset="utf-8"></head>
<body>
<p>black keys: S,D,G,H,J<br/>white keys: Z,X,C,V,B,N,M</p>
<script id="script_main" type="text/javascript">
const root12th2 = Math.pow(2, 1/12);
const a4hz = 440.00;
var transpose = 12;
var aCtx = new (window.AudioContext || window.webkitAudioContext)();
var oscs = [];
var conv = aCtx.createConvolver();
var gain = aCtx.createGain();

conv.buffer = impulseResponse(8,128,false);
gain.gain.value = 0.1;

conv.connect(gain);
gain.connect(aCtx.destination);

document.addEventListener('keydown', (event) => {
	const keyCode = event.keyCode;
	if (keyCode == 191 || keyCode == 222) { event.preventDefault(); }
	if (oscs[keyCode]) { return; }
	var note = transpose;
	if(keyCode == 81) { note += -33; }			//q
	else if(keyCode == 50) { note += -32; }		//2
	else if(keyCode == 87) { note += -31; }		//w
	else if(keyCode == 51) { note += -30; }		//3
	else if(keyCode == 69) { note += -29; }		//e
	else if(keyCode == 82) { note += -28; }		//r
	else if(keyCode == 53) { note += -27; }		//5
	else if(keyCode == 84) { note += -26; }		//t
	else if(keyCode == 54) { note += -25; }		//6
	else if(keyCode == 89) { note += -24; }		//y
	else if(keyCode == 55) { note += -23; }		//7
	else if(keyCode == 85) { note += -22; }		//u
	else if(keyCode == 73) { note += -21; }		//i
	else if(keyCode == 57) { note += -20; }		//9
	else if(keyCode == 79) { note += -19; }		//o
	else if(keyCode == 48) { note += -18; }		//0
	else if(keyCode == 80) { note += -17; }		//p
	else if(keyCode == 219) { note += -16; }	//[
	else if(keyCode == 61) { note += -15; }		//=
	else if(keyCode == 221) { note += -14; }	//]
	else if(keyCode == 65) { note += -13; }		//a
	else if(keyCode == 90) { note += -12; }		//z
	else if(keyCode == 83) { note += -11; }		//s
	else if(keyCode == 88) { note += -10; }		//x
	else if(keyCode == 67) { note += -9; }		//c
	else if(keyCode == 70) { note += -8; }		//f
	else if(keyCode == 86) { note += -7; }		//v
	else if(keyCode == 71) { note += -6; }		//g
	else if(keyCode == 66) { note += -5; }		//b
	else if(keyCode == 78) { note += -4; }		//n
	else if(keyCode == 74) { note += -3; }		//j
	else if(keyCode == 77) { note += -2; }		//m
	else if(keyCode == 75) { note += -1; }		//k
	else if(keyCode == 188) { note += 0; }		//,
	else if(keyCode == 76) { note += 1; }		//l
	else if(keyCode == 190) { note += 2; }		//.
	else if(keyCode == 191) { note += 3; }		///
	else if(keyCode == 222) { note += 4; }		//'
	else { return; }
	oscs[keyCode] = aCtx.createOscillator();
	oscs[keyCode].onended = function() { oscs[keyCode] = null; };
	oscs[keyCode].type = 'triangle';
	oscs[keyCode].frequency.value = noteHz(note);
	oscs[keyCode].connect(conv);
	oscs[keyCode].start();
});

document.addEventListener('keyup', (event) => {
	const keyCode = event.keyCode;
	if (!oscs[keyCode]) { return; }
	oscs[keyCode].stop();
});

function noteHz(n) {
	return a4hz * Math.pow(root12th2, n);
}

function impulseResponse( duration, decay, reverse ) {
    var sampleRate = aCtx.sampleRate;
    var length = sampleRate * duration;
    var impulse = aCtx.createBuffer(2, length, sampleRate);
    var impulseL = impulse.getChannelData(0);
    var impulseR = impulse.getChannelData(1);

    if (!decay)
        decay = 2.0;
    for (var i = 0; i < length; i++){
      var n = reverse ? length - i : i;
      impulseL[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
      impulseR[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
    }
    return impulse;
}
</script>
</body>
</html>